{
  "hash": "f89f498c3cce3445b1b91842e6ca6d1d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Using Propensity Scores\"\nauthor: \"Lucy D'Agostino McGowan\"\ninstitute: \"Wake Forest University\"\nformat: kakashi-revealjs\n---\n\n\n\n## Propensity scores {.large background-color=\"#23373B\"}\n\nMatching\n\nWeighting\n\nStratification\n\nDirect Adjustment\n\n...\n\n## \n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](img/estimands-cake.png){fig-align='center' width=80%}\n:::\n:::\n\n\n::: tiny\nImage source: Simon Grund\n:::\n\n## Propensity scores {.large background-color=\"#23373B\"}\n\n**Matching**\n\nWeighting\n\nStratification\n\nDirect Adjustment\n\n...\n\n## Target estimands\n\n\n\n### *Average Treatment Effect (ATE)*\n\n$$\\tau = E[Y(1) - Y(0)]$$\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](07-using-pscores_files/figure-revealjs/unnamed-chunk-4-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## Target estimands\n\n<table style=\"width:99%;\">\n<colgroup>\n<col style=\"width: 14%\" />\n<col style=\"width: 14%\" />\n<col style=\"width: 70%\" />\n</colgroup>\n<thead>\n<tr class=\"header\">\n<th><p>Estimand</p></th>\n<th><p>Target population</p></th>\n<th><p>Example Research Question</p></th>\n</tr>\n</thead>\n<tbody>\n<tr class=\"odd\">\n<td><p>ATE</p></td>\n<td><p>Full population</p></td>\n<td><p><em>Should we decide whether to have extra magic hours all mornings to change the wait time for Seven Dwarfs Mine Train between 9-10 AM?</em></p>\n<p><em>Should a specific policy be applied to all eligible observations?</em></p></td>\n</tr>\n</tbody>\n</table>\n\n## Target estimands\n\n### Average Treatment Effect among the Treated (ATT)\n\n$$\\tau = E[Y(1) - Y(0) | Z = 1]$$\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](07-using-pscores_files/figure-revealjs/unnamed-chunk-5-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## Target estimands\n\n<table style=\"width:99%;\">\n<colgroup>\n<col style=\"width: 18%\" />\n<col style=\"width: 18%\" />\n<col style=\"width: 62%\" />\n</colgroup>\n<thead>\n<tr class=\"header\">\n<th><p>Estimand</p></th>\n<th><p>Target population</p></th>\n<th><p>Example Research Question</p></th>\n</tr>\n</thead>\n<tbody>\n<tr class=\"odd\">\n<td><p>ATT</p></td>\n<td><p>Exposed (treated) observations</p></td>\n<td><p><em>Should we stop extra magic hours to change the wait time for Seven Dwarfs Mine Train between 9-10 AMpm?</em></p>\n<p><em>Should we stop our marketing campaign to those currently receiving it?</em></p>\n<p><em>Should medical providers stop recommending treatment for those currently receiving it?</em></p></td>\n</tr>\n</tbody>\n</table>\n\n## Matching in R (ATT)\n\n\n::: {.cell layout-align=\"center\" output-location='fragment'}\n\n```{.r .cell-code  code-line-numbers=\"|2|3-7|\"}\nlibrary(MatchIt)\nm <- matchit(\n  qsmk ~ sex + \n    race + age + I(age^2) + education + \n    smokeintensity + I(smokeintensity^2) + \n    smokeyrs + I(smokeyrs^2) + exercise + \n    active + wt71 + I(wt71^2), \n  data = nhefs_complete\n)\nm\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nA `matchit` object\n - method: 1:1 nearest neighbor matching without replacement\n - distance: Propensity score\n             - estimated with logistic regression\n - number of obs.: 1566 (original), 806 (matched)\n - target estimand: ATT\n - covariates: sex, race, age, I(age^2), education, smokeintensity, I(smokeintensity^2), smokeyrs, I(smokeyrs^2), exercise, active, wt71, I(wt71^2)\n```\n\n\n:::\n:::\n\n\n## Matching in R (ATT)\n\n\n::: {.cell layout-align=\"center\" output-location='fragment'}\n\n```{.r .cell-code}\nmatched_data <- get_matches(m, id = \"i\")\nas_tibble(matched_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 806 × 71\n   i     subclass weights  seqn  qsmk death yrdth modth\n   <chr> <fct>      <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n 1 11    1              1   428     1     0    NA    NA\n 2 1220  1              1 23045     0     0    NA    NA\n 3 15    2              1   446     1     1    88     1\n 4 1082  2              1 22294     0     0    NA    NA\n 5 18    3              1   596     1     0    NA    NA\n 6 534   3              1 14088     0     0    NA    NA\n 7 23    4              1   618     1     0    NA    NA\n 8 697   4              1 18085     0     0    NA    NA\n 9 27    5              1   806     1     0    NA    NA\n10 879   5              1 21128     0     0    NA    NA\n# ℹ 796 more rows\n# ℹ 63 more variables: dadth <dbl>, sbp <dbl>, dbp <dbl>,\n#   sex <fct>, age <dbl>, race <fct>, …\n```\n\n\n:::\n:::\n\n\n## Target estimands\n\n### *Average Treatment Effect among the Controls (ATC)*\n\n$$\\tau = E[Y(1) - Y(0) | Z = 0]$$\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](07-using-pscores_files/figure-revealjs/unnamed-chunk-8-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## Target estimands\n\n<table style=\"width:99%;\">\n<colgroup>\n<col style=\"width: 17%\" />\n<col style=\"width: 17%\" />\n<col style=\"width: 63%\" />\n</colgroup>\n<thead>\n<tr class=\"header\">\n<th><p>Estimand</p></th>\n<th><p>Target population</p></th>\n<th><p>Example Research Question</p></th>\n</tr>\n</thead>\n<tbody>\n<tr class=\"odd\">\n<td><p>ATU</p></td>\n<td><p>Unexposed (control) observations</p></td>\n<td><p><em>Should we add extra magic hours for all days to change the wait time for Seven Dwarfs Mine Train between 9-10 AMpm?</em></p>\n<p><em>Should we extend our marketing campaign to those not receiving it?</em></p>\n<p><em>Should medical providers extend treatment to those not currently receiving it?</em></p></td>\n</tr>\n</tbody>\n</table>\n\n## Matching in R (ATC)\n\n\n::: {.cell layout-align=\"center\" output-location='fragment'}\n\n```{.r .cell-code  code-line-numbers=\"|8\"}\nm <- matchit(\n  qsmk ~ sex + \n    race + age + I(age^2) + education + \n    smokeintensity + I(smokeintensity^2) + \n    smokeyrs + I(smokeyrs^2) + exercise + \n    active + wt71 + I(wt71^2), \n  data = nhefs_complete,\n  estimand = \"ATC\"\n)\nm\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nA `matchit` object\n - method: 1:1 nearest neighbor matching without replacement\n - distance: Propensity score\n             - estimated with logistic regression\n - number of obs.: 1566 (original), 806 (matched)\n - target estimand: ATC\n - covariates: sex, race, age, I(age^2), education, smokeintensity, I(smokeintensity^2), smokeyrs, I(smokeyrs^2), exercise, active, wt71, I(wt71^2)\n```\n\n\n:::\n:::\n\n\n## Target estimands\n\n### *Average Treatment Effect among the Matched (ATM)*\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](07-using-pscores_files/figure-revealjs/unnamed-chunk-10-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## Target estimands\n\n<table style=\"width:99%;\">\n<colgroup>\n<col style=\"width: 13%\" />\n<col style=\"width: 13%\" />\n<col style=\"width: 71%\" />\n</colgroup>\n<thead>\n<tr class=\"header\">\n<th><p>Estimand</p></th>\n<th><p>Target population</p></th>\n<th><p>Example Research Question</p></th>\n</tr>\n</thead>\n<tbody>\n<tr class=\"odd\">\n<td><p>ATM</p></td>\n<td><p>Evenly matchable</p></td>\n<td><p><em>Are there some days we should change whether we are offering extra magic hours in order to change the wait time for Seven Dwarfs Mine Train between 9-10 AMpm?</em></p>\n<p><em>Is there an effect of the exposure for some observations?</em></p>\n<p><em>Should those at clinical equipoise receive treatment?</em></p></td>\n</tr>\n</tbody>\n</table>\n\n## Matching in R (ATM)\n\n\n::: {.cell layout-align=\"center\" output-location='slide'}\n\n```{.r .cell-code  code-line-numbers=\"|8-9\"}\nm <- matchit(\n  qsmk ~ sex + \n    race + age + I(age^2) + education + \n    smokeintensity + I(smokeintensity^2) + \n    smokeyrs + I(smokeyrs^2) + exercise + \n    active + wt71 + I(wt71^2), \n  data = nhefs_complete,\n  link = \"linear.logit\", \n  caliper = 0.1\n) \nm\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nA `matchit` object\n - method: 1:1 nearest neighbor matching without replacement\n - distance: Propensity score [caliper]\n\n             - estimated with logistic regression and linearized\n - caliper: <distance> (0.063)\n - number of obs.: 1566 (original), 780 (matched)\n - target estimand: ATT\n - covariates: sex, race, age, I(age^2), education, smokeintensity, I(smokeintensity^2), smokeyrs, I(smokeyrs^2), exercise, active, wt71, I(wt71^2)\n```\n\n\n:::\n:::\n\n\n. . .\n\nObservations with propensity scores (on the linear logit scale) within 0.1 standard errors (the caliper) will be discarded\n\n## Matching in R (ATM)\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nmatched_data <- get_matches(m, id = \"i\")\nas_tibble(matched_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 780 × 71\n   i     subclass weights  seqn  qsmk death yrdth modth\n   <chr> <fct>      <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n 1 11    1              1   428     1     0    NA    NA\n 2 1220  1              1 23045     0     0    NA    NA\n 3 15    2              1   446     1     1    88     1\n 4 1082  2              1 22294     0     0    NA    NA\n 5 18    3              1   596     1     0    NA    NA\n 6 534   3              1 14088     0     0    NA    NA\n 7 23    4              1   618     1     0    NA    NA\n 8 697   4              1 18085     0     0    NA    NA\n 9 27    5              1   806     1     0    NA    NA\n10 879   5              1 21128     0     0    NA    NA\n# ℹ 770 more rows\n# ℹ 63 more variables: dadth <dbl>, sbp <dbl>, dbp <dbl>,\n#   sex <fct>, age <dbl>, race <fct>, …\n```\n\n\n:::\n:::\n\n\n## *Your Turn 1*\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"countdown\" id=\"timer_17ba7ea4\" data-update-every=\"1\" tabindex=\"0\" style=\"right:0;bottom:0;\">\n<div class=\"countdown-controls\"><button class=\"countdown-bump-down\">&minus;</button><button class=\"countdown-bump-up\">&plus;</button></div>\n<code class=\"countdown-time\"><span class=\"countdown-digits minutes\">06</span><span class=\"countdown-digits colon\">:</span><span class=\"countdown-digits seconds\">00</span></code>\n</div>\n```\n\n:::\n:::\n\n\n### Using the propensity scores you created in the previous exercise, create a \"matched\" data set using the ATM method with a caliper of 0.2.\n\n## Propensity scores {.large background-color=\"#23373B\"}\n\nMatching\n\n**Weighting**\n\nStratification\n\nDirect Adjustment\n\n...\n\n## Histogram of propensity scores\n\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](07-using-pscores_files/figure-revealjs/unnamed-chunk-15-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## Target estimands: ATE {background-color=\"#23373B\"}\n\nAverage Treatment Effect (ATE)\n\n$$\\Large w_{ATE} = \\frac{Z_i}{p_i} + \\frac{1-Z_i}{1 - p_i}$$\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n(Z / p) + ((1 - Z) / (1 - p))\n```\n:::\n\n\n## ATE\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](07-using-pscores_files/figure-revealjs/unnamed-chunk-17-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## Target estimands: ATT & ATC {background-color=\"#23373B\"}\n\n. . .\n\nAverage Treatment Effect Among the Treated (ATT) $$\\Large w_{ATT} = \\frac{p_i Z_i}{p_i} + \\frac{p_i (1-Z_i)}{1-p_i}$$\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n((p * Z) / p) + ((p * (1 - Z)) / (1 - p))\n```\n:::\n\n\n## Target estimands: ATT & ATC {background-color=\"#23373B\"}\n\nAverage Treatment Effect Among the Controls (ATC) $$\\Large w_{ATC} = \\frac{(1-p_i)Z_i}{p_i} + \\frac{(1-p_i)(1-Z_i)}{(1-p_i)}$$\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n(((1 - p) * Z) / p) + (((1 - p) * (1 - Z)) / (1 - p))\n```\n:::\n\n\n## ATT\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](07-using-pscores_files/figure-revealjs/unnamed-chunk-20-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## ATC\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](07-using-pscores_files/figure-revealjs/unnamed-chunk-21-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## Target estimands: ATM & ATO {background-color=\"#23373B\"}\n\n. . .\n\nAverage Treatment Effect Among the Evenly Matchable (ATM) $$\\Large w_{ATM} = \\frac{\\min \\{p_i, 1-p_i\\}}{Z_ip_i + (1-Z_i)(1-p_i)}$$\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npmin(p, 1 - p) / (Z * p + (1 - Z) * (1 - p))\n```\n:::\n\n\n## Target estimands: ATM & ATO {background-color=\"#23373B\"}\n\nAverage Treatment Effect Among the Overlap Population $$\\Large w_{ATO} = (1-p_i)Z_i + p_i(1-Z_i)$$\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n(1 - p) * Z + p * (1 - Z)\n```\n:::\n\n\n## Target estimands\n\n| Estimand | Target population  | Example Research Question |\n|----------|--------------------|---------------------------|\n| ATO     | Overlap population | *Same as ATM*             |\n\n## ATM\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](07-using-pscores_files/figure-revealjs/unnamed-chunk-24-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## ATO\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](07-using-pscores_files/figure-revealjs/unnamed-chunk-25-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## ATE in R ![](img/hex/propensity.png){.absolute top=\"0\" right=\"0\" width=\"140\"}\n\n<br />\n\nAverage Treatment Effect (ATE) $w_{ATE} = \\frac{Z_i}{p_i} + \\frac{1-Z_i}{1 - p_i}$\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"|4\"}\nlibrary(propensity)\ndf <- propensity_model |>\n  augment(type.predict = \"response\", data = nhefs_complete) |>\n  mutate(w_ate = wt_ate(.fitted, qsmk)) \n```\n:::\n\n\n## *Your Turn 2*\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"countdown\" id=\"timer_7263ec84\" data-update-every=\"1\" tabindex=\"0\" style=\"right:0;bottom:0;\">\n<div class=\"countdown-controls\"><button class=\"countdown-bump-down\">&minus;</button><button class=\"countdown-bump-up\">&plus;</button></div>\n<code class=\"countdown-time\"><span class=\"countdown-digits minutes\">06</span><span class=\"countdown-digits colon\">:</span><span class=\"countdown-digits seconds\">00</span></code>\n</div>\n```\n\n:::\n:::\n\n\n### Using the propensity scores you created in the previous exercise, add the ATE weights to your data frame\n\n### *Stretch*: Using the same propensity scores, create ATM weights\n",
    "supporting": [
      "07-using-pscores_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"07-using-pscores_files/libs/countdown-0.4.0/countdown.css\" rel=\"stylesheet\" />\n<script src=\"07-using-pscores_files/libs/countdown-0.4.0/countdown.js\"></script>\n"
      ],
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}