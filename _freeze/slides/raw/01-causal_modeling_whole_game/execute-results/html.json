{
  "hash": "9787509657b4807fb0690e23c42f9453",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Causal Modeling in R: Whole Game\"\nauthor: \"Malcolm Barrett\"\ninstitute: \"Stanford University\"\nformat: \"kakashi-revealjs\"\n---\n\n## {background-color=\"#23373B\"}\n\n\n\n1. Specify causal question (e.g. target trial)\n2. Draw assumptions (causal diagram)\n3. Model assumptions (e.g., propensity)\n4. Diagnose model (e.g., balance)\n5. Estimate causal effects (e.g., IPW) \n6. Sensitivity analysis (more later!)\n\n\n## {background-color=\"#23373B\" .center}\n\n### **We'll focus on the broader ideas behind each step and what they look like all together; we don't expect you to fully digest each idea. We'll spend the rest of the workshop taking up each step in detail**\n\n## {background-color=\"#23373B\" .center}\n\n### **Do people who quit smoking gain weight?**\n\n---\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(causaldata)\nnhefs_complete_uc <- nhefs_complete |>\n  filter(censored == 0)\nnhefs_complete_uc\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1,566 × 67\n    seqn  qsmk death yrdth modth dadth   sbp   dbp sex  \n   <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <fct>\n 1   233     0     0    NA    NA    NA   175    96 0    \n 2   235     0     0    NA    NA    NA   123    80 0    \n 3   244     0     0    NA    NA    NA   115    75 1    \n 4   245     0     1    85     2    14   148    78 0    \n 5   252     0     0    NA    NA    NA   118    77 0    \n 6   257     0     0    NA    NA    NA   141    83 1    \n 7   262     0     0    NA    NA    NA   132    69 1    \n 8   266     0     0    NA    NA    NA   100    53 1    \n 9   419     0     1    84    10    13   163    79 0    \n10   420     0     1    86    10    17   184   106 0    \n# ℹ 1,556 more rows\n# ℹ 58 more variables: age <dbl>, race <fct>, income <dbl>,\n#   marital <dbl>, school <dbl>, education <fct>, …\n```\n\n\n:::\n:::\n\n\n## Did those who quit smoking gain weight?\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](01-causal_modeling_whole_game_files/figure-revealjs/unnamed-chunk-2-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n---\n\n## Did those who quit smoking gain weight?\n\n\n::: {.cell layout-align=\"center\" highlight.output='[4,5]'}\n\n```{.r .cell-code}\n# ~2.5 KGs gained for quit vs. not quit\nnhefs_complete_uc |>\n  group_by(qsmk) |>\n  summarize(\n    mean_weight_change = mean(wt82_71), \n    sd = sd(wt82_71),\n    .groups = \"drop\"\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 3\n   qsmk mean_weight_change    sd\n  <dbl>              <dbl> <dbl>\n1     0               1.98  7.45\n2     1               4.53  8.75\n```\n\n\n:::\n:::\n\n\n## {background-color=\"#23373B\" .center}\n\n### **draw your assumptions**\n\n---\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](01-causal_modeling_whole_game_files/figure-revealjs/unnamed-chunk-4-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n---\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](01-causal_modeling_whole_game_files/figure-revealjs/unnamed-chunk-5-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## {background-color=\"#23373B\" .center}\n\n### What do I need to control for?\n\n---\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](01-causal_modeling_whole_game_files/figure-revealjs/unnamed-chunk-6-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n\n---\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](01-causal_modeling_whole_game_files/figure-revealjs/unnamed-chunk-7-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## Multivariable regression: what's the association?\n\n\n::: {.cell layout-align=\"center\" output-location='fragment'}\n\n```{.r .cell-code  code-line-numbers=\"|1-8\"}\nlm( \n  wt82_71 ~ qsmk + sex +  \n    race + age + I(age^2) + education + \n    smokeintensity + I(smokeintensity^2) + \n    smokeyrs + I(smokeyrs^2) + exercise + active + \n    wt71 + I(wt71^2), \n  data = nhefs_complete_uc \n) |>\n  tidy(conf.int = TRUE) |>\n  filter(term == \"qsmk\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 7\n  term  estimate std.error statistic  p.value conf.low\n  <chr>    <dbl>     <dbl>     <dbl>    <dbl>    <dbl>\n1 qsmk      3.46     0.438      7.90 5.36e-15     2.60\n# ℹ 1 more variable: conf.high <dbl>\n```\n\n\n:::\n:::\n\n\n## {background-color=\"#23373B\" .center}\n\n### **model your assumptions**\n\n\n## {background-color=\"#23373B\" .center}\n\n### counterfactual: what if <u>everyone</u> quit smoking vs. what if <u>no one</u> quit smoking\n\n## Fit propensity score model\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"|1-2\"}\npropensity_model <- glm( \n  qsmk ~ sex +  \n    race + age + I(age^2) + education + \n    smokeintensity + I(smokeintensity^2) + \n    smokeyrs + I(smokeyrs^2) + exercise + active + \n    wt71 + I(wt71^2), \n  family = binomial(), \n  data = nhefs_complete_uc\n)\n```\n:::\n\n\n## Calculate inverse probability weights\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"|4,6\"}\nlibrary(propensity)\nnhefs_complete_uc <- propensity_model |>\n  # predict whether quit smoking\n  augment(type.predict = \"response\", data = nhefs_complete_uc) |>\n  # calculate inverse probability\n  mutate(wts = wt_ate(.fitted, qsmk)) \n```\n:::\n\n\n## {background-color=\"#23373B\" .center}\n\n### **diagnose your model assumptions**\n\n## What's the distribution of weights?\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](01-causal_modeling_whole_game_files/figure-revealjs/unnamed-chunk-11-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## What are the weights doing to the sample?\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](01-causal_modeling_whole_game_files/figure-revealjs/unnamed-chunk-12-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## What are the weights doing to the sample?\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](01-causal_modeling_whole_game_files/figure-revealjs/unnamed-chunk-13-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n---\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](01-causal_modeling_whole_game_files/figure-revealjs/unnamed-chunk-15-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n---\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](01-causal_modeling_whole_game_files/figure-revealjs/unnamed-chunk-16-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## {background-color=\"#23373B\" .center}\n\n### **estimate the causal effects**\n\n## Estimate causal effect with IPW\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"|1-2,4\"}\nipw_model <- lm( \n  wt82_71 ~ qsmk, \n  data = nhefs_complete_uc, \n  weights = wts \n) \n\nipw_estimate <- ipw_model |>\n  tidy(conf.int = TRUE) |>\n  filter(term == \"qsmk\")\n```\n:::\n\n\n## Estimate causal effect with IPW\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nipw_estimate\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 7\n  term  estimate std.error statistic  p.value conf.low\n  <chr>    <dbl>     <dbl>     <dbl>    <dbl>    <dbl>\n1 qsmk      3.44     0.408      8.43 7.47e-17     2.64\n# ℹ 1 more variable: conf.high <dbl>\n```\n\n\n:::\n:::\n\n\n## Let's fix our confidence intervals with robust SEs!\n\n. . .\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"|3-4,6\"}\n# also see robustbase, survey, gee, and others\nlibrary(estimatr)\nipw_model_robust <- lm_robust( \n  wt82_71 ~ qsmk, \n  data = nhefs_complete_uc, \n  weights = wts \n) \n\nipw_estimate_robust <- ipw_model_robust |>\n  tidy(conf.int = TRUE) |>\n  filter(term == \"qsmk\")\n```\n:::\n\n\n---\n\n## Let's fix our confidence intervals with robust SEs!\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nas_tibble(ipw_estimate_robust)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 9\n  term  estimate std.error statistic  p.value conf.low\n  <chr>    <dbl>     <dbl>     <dbl>    <dbl>    <dbl>\n1 qsmk      3.44     0.526      6.54 8.57e-11     2.41\n# ℹ 3 more variables: conf.high <dbl>, df <dbl>,\n#   outcome <chr>\n```\n\n\n:::\n:::\n\n\n---\n\n## Let's fix our confidence intervals with the bootstrap!\n\n. . .\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# fit ipw model for a single bootstrap sample\nfit_ipw_not_quite_rightly <- function(.split, ...) { \n  # get bootstrapped data frame\n  .df <- as.data.frame(.split)\n  \n  # fit ipw model\n  lm(wt82_71 ~ qsmk, data = .df, weights = wts) |>\n    tidy()\n}\n```\n:::\n\n\n## {.small}\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfit_ipw <- function(.split, ...) {\n  # get bootstrapped data frame\n  .df <- as.data.frame(.split)\n  \n  # fit propensity score model\n  propensity_model <- glm(\n    qsmk ~ sex + \n      race + age + I(age^2) + education + \n      smokeintensity + I(smokeintensity^2) + \n      smokeyrs + I(smokeyrs^2) + exercise + active + \n      wt71 + I(wt71^2), \n    family = binomial(), \n    data = .df\n  )\n  \n  # calculate inverse probability weights\n  .df <- propensity_model |>\n    augment(type.predict = \"response\", data = .df) |>\n    mutate(wts = wt_ate(.fitted, qsmk))\n  \n  # fit correctly bootstrapped ipw model\n  lm(wt82_71 ~ qsmk, data = .df, weights = wts) |>\n    tidy()\n}\n```\n:::\n\n\n## Using {rsample} to bootstrap our causal effect\n\n. . .\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"|2-3\"}\n# fit ipw model to bootstrapped samples\nipw_results <- bootstraps(nhefs_complete_uc, 1000, apparent = TRUE) |>\n  mutate(results = map(splits, fit_ipw)) \n```\n:::\n\n\n## Using {rsample} to bootstrap our causal effect\n\n\n::: {.cell layout-align=\"center\" output-location='slide'}\n\n```{.r .cell-code  code-line-numbers=\"|2\"}\n# get t-statistic-based CIs\nboot_estimate <- int_t(ipw_results, results) |> \n  filter(term == \"qsmk\")\n\nboot_estimate\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 6\n  term  .lower .estimate .upper .alpha .method  \n  <chr>  <dbl>     <dbl>  <dbl>  <dbl> <chr>    \n1 qsmk    2.46      3.45   4.40   0.05 student-t\n```\n\n\n:::\n:::\n\n\n## {.center}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](01-causal_modeling_whole_game_files/figure-revealjs/unnamed-chunk-24-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## {background-color=\"#23373B\" .center}\n\n### *Our causal effect estimate: **3.5 kg (95% CI 2.4 kg, 4.4 kg)***\n\n## {background-color=\"#23373B\" .center}\n\n### **Review the Quarto file... later!**\n\n## Resources {background-color=\"#23373B\"}\n### [Causal Inference](https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/): Comprehensive text on causal inference. Free online.\n### [Bootstrap confidence intervals with {rsample}](https://rsample.tidymodels.org/articles/Applications/Intervals.html)\n### [R-causal](https://github.com/r-causal): Our GitHub org with R packages and examples\n",
    "supporting": [
      "01-causal_modeling_whole_game_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}